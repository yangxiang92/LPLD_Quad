###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.40.1.53790/W32 for ARM     20/Mar/2014  08:44:52 #
# Copyright 1999-2012 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\lib\LPLD\DE #
#                    V\DEV_MMA7660.c                                          #
#    Command line =  E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\lib\LPLD\DE #
#                    V\DEV_MMA7660.c -D LPLD_K60 -lCN                         #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\RAM\Lis #
#                    t\ -lB E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\ #
#                    RAM\List\ -o E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V #
#                    2\iar\RAM\Obj\ --no_cse --no_unroll --no_inline          #
#                    --no_code_motion --no_tbaa --no_clustering               #
#                    --no_scheduling --debug --endian=little --cpu=Cortex-M4  #
#                    -e --fpu=None --dlib_config "D:\Program Files\IAR        #
#                    Systems\Embedded Workbench 6.4\arm\INC\c\DLib_Config_Nor #
#                    mal.h" -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\i #
#                    ar\..\app\ -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_ #
#                    V2\iar\..\lib\CPU\ -I E:\ShawnDocuments\IAR_WorkSpace\LP #
#                    LD_Quad_V2\iar\..\lib\common\ -I                         #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\..\lib\ #
#                    LPLD\ -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\ia #
#                    r\..\lib\LPLD\HW\ -I E:\ShawnDocuments\IAR_WorkSpace\LPL #
#                    D_Quad_V2\iar\..\lib\LPLD\DEV\ -I                        #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\..\lib\ #
#                    uCOS-II\Ports\ -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Q #
#                    uad_V2\iar\..\lib\uCOS-II\Source\ -I                     #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\..\lib\ #
#                    FatFs\ -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\i #
#                    ar\..\lib\FatFs\option\ -I E:\ShawnDocuments\IAR_WorkSpa #
#                    ce\LPLD_Quad_V2\iar\..\lib\USB\common\ -I                #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\..\lib\ #
#                    USB\driver\ -I E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad #
#                    _V2\iar\..\lib\USB\descriptor\ -I                        #
#                    E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\..\lib\ #
#                    USB\class\ -Ol -I "D:\Program Files\IAR                  #
#                    Systems\Embedded Workbench 6.4\arm\CMSIS\Include\" -D    #
#                    ARM_MATH_CM4                                             #
#    List file    =  E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\RAM\Lis #
#                    t\DEV_MMA7660.lst                                        #
#    Object file  =  E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\iar\RAM\Obj #
#                    \DEV_MMA7660.o                                           #
#                                                                             #
#                                                                             #
###############################################################################

E:\ShawnDocuments\IAR_WorkSpace\LPLD_Quad_V2\lib\LPLD\DEV\DEV_MMA7660.c
      1          /**
      2           * @file DEV_MMA7660.c
      3           * @version 0.1[By LPLD]
      4           * @date 2013-09-24
      5           * @brief MMA7660三轴加速度传感器设备驱动程序
      6           *
      7           * 更改建议:可根据实际硬件修改
      8           *
      9           * 版权所有:北京拉普兰德电子技术有限公司
     10           * http://www.lpld.cn
     11           * mail:support@lpld.cn
     12           *
     13           * @par
     14           * 本代码由拉普兰德[LPLD]开发并维护，并向所有使用者开放源代码。
     15           * 开发者可以随意修使用或改源代码。但本段及以上注释应予以保留。
     16           * 不得更改或删除原版权所有者姓名，二次开发者可以加注二次版权所有者。
     17           * 但应在遵守此协议的基础上，开放源代码、不得出售代码本身。
     18           * 拉普兰德不负责由于使用本代码所带来的任何事故、法律责任或相关不良影响。
     19           * 拉普兰德无义务解释、说明本代码的具体原理、功能、实现方法。
     20           * 除非拉普兰德[LPLD]授权，开发者不得将本代码用于商业产品。
     21           */
     22          #include "DEV_MMA7660.h"
     23          
     24          static void MMA7660_Delay(void);
     25          
     26          /*
     27           *   LPLD_MMA7660_Init
     28           *   初始化MMA7660，包括初始化7660所需的I2C接口以及7660的寄存器
     29           *
     30           *   参数：
     31           *    无
     32           */

   \                                 In section .text, align 2, keep-with-next
     33          void LPLD_MMA7660_Init(void)
     34          {
   \                     LPLD_MMA7660_Init:
   \   00000000   0xB500             PUSH     {LR}
   \   00000002   0xB085             SUB      SP,SP,#+20
     35            I2C_InitTypeDef i2c_init_param;
     36              
     37            //初始化MMA7660_I2CX
     38            i2c_init_param.I2C_I2Cx = MMA7660_I2CX;       //在DEV_MMA7660.h中修改该值
   \   00000004   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000006   0x9000             STR      R0,[SP, #+0]
     39            i2c_init_param.I2C_IntEnable = FALSE;
   \   00000008   0x2000             MOVS     R0,#+0
   \   0000000A   0xF88D 0x0005      STRB     R0,[SP, #+5]
     40            i2c_init_param.I2C_ICR = MMA7660_SCL_200KHZ;  //可根据实际电路更改SCL频率
   \   0000000E   0x2023             MOVS     R0,#+35
   \   00000010   0xF88D 0x0004      STRB     R0,[SP, #+4]
     41            i2c_init_param.I2C_SclPin = MMA7660_SCLPIN;   //在DEV_MMA7660.h中修改该值
   \   00000014   0x2064             MOVS     R0,#+100
   \   00000016   0xF88D 0x0006      STRB     R0,[SP, #+6]
     42            i2c_init_param.I2C_SdaPin = MMA7660_SDAPIN;   //在DEV_MMA7660.h中修改该值
   \   0000001A   0x2065             MOVS     R0,#+101
   \   0000001C   0xF88D 0x0007      STRB     R0,[SP, #+7]
     43            i2c_init_param.I2C_Isr = NULL;
   \   00000020   0x2000             MOVS     R0,#+0
   \   00000022   0x9003             STR      R0,[SP, #+12]
     44            
     45            LPLD_I2C_Init(i2c_init_param);
   \   00000024   0xA800             ADD      R0,SP,#+0
   \   00000026   0xC80F             LDM      R0,{R0-R3}
   \   00000028   0x.... 0x....      BL       LPLD_I2C_Init
     46          
     47            LPLD_MMA7660_WriteReg(MMA7660_MODE, 0x00); //Disable tap detection
   \   0000002C   0x2100             MOVS     R1,#+0
   \   0000002E   0x2007             MOVS     R0,#+7
   \   00000030   0x.... 0x....      BL       LPLD_MMA7660_WriteReg
     48            LPLD_MMA7660_WriteReg(MMA7660_SR, 0x02);   //Enable auto-sleep, auto-wake, and put in active mode
   \   00000034   0x2102             MOVS     R1,#+2
   \   00000036   0x2008             MOVS     R0,#+8
   \   00000038   0x.... 0x....      BL       LPLD_MMA7660_WriteReg
     49            LPLD_MMA7660_WriteReg(MMA7660_MODE, 0x11); //Disable tap detection
   \   0000003C   0x2111             MOVS     R1,#+17
   \   0000003E   0x2007             MOVS     R0,#+7
   \   00000040   0x.... 0x....      BL       LPLD_MMA7660_WriteReg
     50          }
   \   00000044   0xB005             ADD      SP,SP,#+20
   \   00000046   0xBD00             POP      {PC}             ;; return
     51          
     52          /*
     53           *   LPLD_MMA7660_WriteReg
     54           *   该函数用于配置MMA7660的寄存器
     55           *
     56           *   参数：
     57           *   RegisterAddress 
     58           *    |__ MMA7660寄存器地址
     59           *   Data
     60           *    |__ 具体写入的字节型数据 
     61           */

   \                                 In section .text, align 2, keep-with-next
     62          void LPLD_MMA7660_WriteReg(uint8 RegisterAddress, uint8 Data)
     63          {
   \                     LPLD_MMA7660_WriteReg:
   \   00000000   0xB538             PUSH     {R3-R5,LR}
   \   00000002   0x0004             MOVS     R4,R0
   \   00000004   0x000D             MOVS     R5,R1
     64            //发送从机地址
     65            LPLD_I2C_StartTrans(MMA7660_I2CX, MMA7660_DEV_ADDR, I2C_MWSR);
   \   00000006   0x2200             MOVS     R2,#+0
   \   00000008   0x214C             MOVS     R1,#+76
   \   0000000A   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000000C   0x.... 0x....      BL       LPLD_I2C_StartTrans
     66            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000010   0x2101             MOVS     R1,#+1
   \   00000012   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000014   0x.... 0x....      BL       LPLD_I2C_WaitAck
     67            
     68            //写MMA7660寄存器地址
     69            LPLD_I2C_WriteByte(MMA7660_I2CX, RegisterAddress);
   \   00000018   0x0021             MOVS     R1,R4
   \   0000001A   0xB2C9             UXTB     R1,R1            ;; ZeroExt  R1,R1,#+24,#+24
   \   0000001C   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000001E   0x.... 0x....      BL       LPLD_I2C_WriteByte
     70            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000022   0x2101             MOVS     R1,#+1
   \   00000024   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000026   0x.... 0x....      BL       LPLD_I2C_WaitAck
     71            
     72            //向寄存器中写具体数据
     73            LPLD_I2C_WriteByte(MMA7660_I2CX, Data);
   \   0000002A   0x0029             MOVS     R1,R5
   \   0000002C   0xB2C9             UXTB     R1,R1            ;; ZeroExt  R1,R1,#+24,#+24
   \   0000002E   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000030   0x.... 0x....      BL       LPLD_I2C_WriteByte
     74            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000034   0x2101             MOVS     R1,#+1
   \   00000036   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000038   0x.... 0x....      BL       LPLD_I2C_WaitAck
     75          
     76            LPLD_I2C_Stop(MMA7660_I2CX);
   \   0000003C   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000003E   0x.... 0x....      BL       LPLD_I2C_Stop
     77          
     78            //MMA7660_Delay();
     79          }
   \   00000042   0xBD31             POP      {R0,R4,R5,PC}    ;; return
     80          
     81          /*
     82           *   LPLD_MMA7660_WriteReg
     83           *   该函数用于读取MMA7660的数据
     84           *
     85           *   参数：
     86           *     RegisterAddress 
     87           *        |__ MMA7660寄存器地址
     88           *   返回值
     89           *      加速传感器的测量值
     90           */

   \                                 In section .text, align 2, keep-with-next
     91          uint8 LPLD_MMA7660_ReadReg(uint8 RegisterAddress)
     92          {
   \                     LPLD_MMA7660_ReadReg:
   \   00000000   0xB510             PUSH     {R4,LR}
   \   00000002   0x0004             MOVS     R4,R0
     93            uint8 result;
     94          
     95            //发送从机地址
     96            LPLD_I2C_StartTrans(MMA7660_I2CX, MMA7660_DEV_ADDR, I2C_MWSR);
   \   00000004   0x2200             MOVS     R2,#+0
   \   00000006   0x214C             MOVS     R1,#+76
   \   00000008   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000000A   0x.... 0x....      BL       LPLD_I2C_StartTrans
     97            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   0000000E   0x2101             MOVS     R1,#+1
   \   00000010   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000012   0x.... 0x....      BL       LPLD_I2C_WaitAck
     98          
     99            //写MMA7660寄存器地址
    100            LPLD_I2C_WriteByte(MMA7660_I2CX, RegisterAddress);
   \   00000016   0x0021             MOVS     R1,R4
   \   00000018   0xB2C9             UXTB     R1,R1            ;; ZeroExt  R1,R1,#+24,#+24
   \   0000001A   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000001C   0x.... 0x....      BL       LPLD_I2C_WriteByte
    101            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000020   0x2101             MOVS     R1,#+1
   \   00000022   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000024   0x.... 0x....      BL       LPLD_I2C_WaitAck
    102          
    103            //再次产生开始信号
    104            LPLD_I2C_ReStart(MMA7660_I2CX);
   \   00000028   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000002A   0x.... 0x....      BL       LPLD_I2C_ReStart
    105          
    106            //发送从机地址和读取位
    107            LPLD_I2C_WriteByte(MMA7660_I2CX, MMA7660_DEV_READ);
   \   0000002E   0x2199             MOVS     R1,#+153
   \   00000030   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000032   0x.... 0x....      BL       LPLD_I2C_WriteByte
    108            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000036   0x2101             MOVS     R1,#+1
   \   00000038   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000003A   0x.... 0x....      BL       LPLD_I2C_WaitAck
    109          
    110            //转换主机模式为读
    111            LPLD_I2C_SetMasterWR(MMA7660_I2CX, I2C_MRSW);
   \   0000003E   0x2101             MOVS     R1,#+1
   \   00000040   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000042   0x.... 0x....      BL       LPLD_I2C_SetMasterWR
    112          
    113            //关闭应答ACK
    114            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_OFF);//关闭ACK
   \   00000046   0x2100             MOVS     R1,#+0
   \   00000048   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000004A   0x.... 0x....      BL       LPLD_I2C_WaitAck
    115          
    116            //读IIC数据
    117            result =LPLD_I2C_ReadByte(MMA7660_I2CX);
   \   0000004E   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000050   0x.... 0x....      BL       LPLD_I2C_ReadByte
   \   00000054   0x0004             MOVS     R4,R0
    118            LPLD_I2C_WaitAck(MMA7660_I2CX, I2C_ACK_ON);
   \   00000056   0x2101             MOVS     R1,#+1
   \   00000058   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   0000005A   0x.... 0x....      BL       LPLD_I2C_WaitAck
    119          
    120            //发送停止信号
    121            LPLD_I2C_Stop(MMA7660_I2CX);
   \   0000005E   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000060   0x.... 0x....      BL       LPLD_I2C_Stop
    122          
    123             //读IIC数据
    124            result = LPLD_I2C_ReadByte(MMA7660_I2CX);
   \   00000064   0x....             LDR.N    R0,??DataTable2  ;; 0x40066000
   \   00000066   0x.... 0x....      BL       LPLD_I2C_ReadByte
   \   0000006A   0x0004             MOVS     R4,R0
    125            
    126            MMA7660_Delay();
   \   0000006C   0x.... 0x....      BL       MMA7660_Delay
    127          
    128            return result;
   \   00000070   0x0020             MOVS     R0,R4
   \   00000072   0xB2C0             UXTB     R0,R0            ;; ZeroExt  R0,R0,#+24,#+24
   \   00000074   0xBD10             POP      {R4,PC}          ;; return
    129          }
    130          
    131          /*
    132           * 函数功能：读MAA7660加速度输出
    133           * 参数w
    134           *       Regs_Addr - 加速度寄存器地址
    135           * 函数返回值：加速度值（int8）
    136           */   

   \                                 In section .text, align 2, keep-with-next
    137          int8 LPLD_MMA7660_GetResult(uint8 Regs_Addr) 
    138          {
   \                     LPLD_MMA7660_GetResult:
   \   00000000   0xB510             PUSH     {R4,LR}
   \   00000002   0x0004             MOVS     R4,R0
    139             char ret;
    140             
    141             if(Regs_Addr>MMA7660_ZOUT)
   \   00000004   0xB2E4             UXTB     R4,R4            ;; ZeroExt  R4,R4,#+24,#+24
   \   00000006   0x2C03             CMP      R4,#+3
   \   00000008   0xD301             BCC.N    ??LPLD_MMA7660_GetResult_0
    142              return 0;
   \   0000000A   0x2000             MOVS     R0,#+0
   \   0000000C   0xE00B             B.N      ??LPLD_MMA7660_GetResult_1
    143             
    144             // 等待转换完成并取出值   
    145             ret=LPLD_MMA7660_ReadReg(Regs_Addr);
   \                     ??LPLD_MMA7660_GetResult_0:
   \   0000000E   0x0020             MOVS     R0,R4
   \   00000010   0xB2C0             UXTB     R0,R0            ;; ZeroExt  R0,R0,#+24,#+24
   \   00000012   0x.... 0x....      BL       LPLD_MMA7660_ReadReg
   \   00000016   0xE003             B.N      ??LPLD_MMA7660_GetResult_2
    146             while(ret&0x40) {
    147              ret=LPLD_MMA7660_ReadReg(Regs_Addr);
   \                     ??LPLD_MMA7660_GetResult_3:
   \   00000018   0x0020             MOVS     R0,R4
   \   0000001A   0xB2C0             UXTB     R0,R0            ;; ZeroExt  R0,R0,#+24,#+24
   \   0000001C   0x.... 0x....      BL       LPLD_MMA7660_ReadReg
    148             }
   \                     ??LPLD_MMA7660_GetResult_2:
   \   00000020   0x0641             LSLS     R1,R0,#+25
   \   00000022   0xD4F9             BMI.N    ??LPLD_MMA7660_GetResult_3
    149           
    150             return ret;
   \   00000024   0xB240             SXTB     R0,R0            ;; SignExt  R0,R0,#+24,#+24
   \                     ??LPLD_MMA7660_GetResult_1:
   \   00000026   0xBD10             POP      {R4,PC}          ;; return
    151          
    152          }
    153          
    154          
    155          /*
    156           * 延时函数
    157           */

   \                                 In section .text, align 4, keep-with-next
    158          static void MMA7660_Delay(void){
    159            int n;
    160            for(n=1;n<200;n++) {
   \                     MMA7660_Delay:
   \   00000000   0x2001             MOVS     R0,#+1
   \   00000002   0xE001             B.N      ??MMA7660_Delay_0
    161              asm("nop");
   \                     ??MMA7660_Delay_1:
   \   00000004   0xBF00             nop
    162            }
   \   00000006   0x1C40             ADDS     R0,R0,#+1
   \                     ??MMA7660_Delay_0:
   \   00000008   0x28C8             CMP      R0,#+200
   \   0000000A   0xDBFB             BLT.N    ??MMA7660_Delay_1
    163          }
   \   0000000C   0x4770             BX       LR               ;; return

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2:
   \   00000000   0x40066000         DC32     0x40066000

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
        8  LPLD_MMA7660_GetResult
              8 -> LPLD_MMA7660_ReadReg
       24  LPLD_MMA7660_Init
             24 -> LPLD_I2C_Init
             24 -> LPLD_MMA7660_WriteReg
        8  LPLD_MMA7660_ReadReg
              8 -> LPLD_I2C_ReStart
              8 -> LPLD_I2C_ReadByte
              8 -> LPLD_I2C_SetMasterWR
              8 -> LPLD_I2C_StartTrans
              8 -> LPLD_I2C_Stop
              8 -> LPLD_I2C_WaitAck
              8 -> LPLD_I2C_WriteByte
              8 -> MMA7660_Delay
       16  LPLD_MMA7660_WriteReg
             16 -> LPLD_I2C_StartTrans
             16 -> LPLD_I2C_Stop
             16 -> LPLD_I2C_WaitAck
             16 -> LPLD_I2C_WriteByte
        0  MMA7660_Delay


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable2
      40  LPLD_MMA7660_GetResult
      72  LPLD_MMA7660_Init
     118  LPLD_MMA7660_ReadReg
      68  LPLD_MMA7660_WriteReg
      14  MMA7660_Delay

 
 316 bytes in section .text
 
 316 bytes of CODE memory

Errors: none
Warnings: none
